function ShowReashoInput()
{
    $(".fixed,.layers").show();
}
function CancleInput()
{
    $(".fixed,.layers").hide();
}

function getDictionaryItems(typeId, callback)
{
    sendPostRequest("/OrderHandlers/Apply.ashx/GetDictionaryItems", JSON.stringify({ sdType: typeId }), callback, $.noop);
}

function CheckReason()
{
    var reason = $.trim($("#Reason").val());
    if (reason == "")
    {
        alert("请输入拒绝原因");
        $("#Reason").select();
        return false;
    } else if (reason.length > 200)
    {
        alert("拒绝原因不能超过200字");
        $("#Reason").select();
        return false;
    } else if ($("#divDeny .check :checked").size() == 0)
    {
        alert("请选择拒绝类型");
        return false;
    }
    return true;
}

function CheckRate()
{
    var isOk = true;
    $(".faxInput").each(function ()
    {
        var that = $(this);
        if ($.trim(that.val()) == "")
        {
            isOk = false;
            return false;
        }
        if (!rateReg.test($(this).val()))
        {
            isOk = false;
            return false;
        }
    });
    $(".FeeInput").each(function ()
    {
        var that = $(this);
        if ($.trim(that.val()) == "")
        {
            isOk = false;
            return false;
        }
        if (!feeReg.test($(this).val()))
        {
            isOk = false;
            return false;
        }
    });
    if (!isOk)
    {
        alert("请输入正确的费率和手续费！");
    }
    var pnr = $.trim($("#txtPNR").val());
    var bpnr = $.trim($("#txtBPNR").val());
    if (RequireSeparatePNR)
    {
        if (pnr == "" && bpnr == "")
        {
            alert("没有输入分离编码");
            return false;
        } else if (pnr != "" && !pnrReg.test(pnr))
        {
            alert("小编码格式不正确！");
            return false;
        }
        if (bpnr != "" && !pnrReg.test(bpnr))
        {
            alert("大编码格式不正确");
            return false;
        }
    }

    return isOk;
}

var rateReg = /^100$|^[1-9]?\d$/;
var feeReg = /^\d+(\.\d{1,2})?$/;
var pnrReg = /^[\w\d]{6}$/;
var zhengshu = /^\d+$/;

function ReCalc(sender)
{
    var that = $(sender);
    if ($.trim(that.val()) == "") return;
    if (/^\d+$/.test(that.val()))
    {
        if (!rateReg.test(that.val()))
        {
            that.val(100);
        }
    } else
    {
        alert("费率输入错误！");
        return;
    }

    var rate = parseInt(that.val());
    var container = that.parent().parent().parent();
    var ticketPrice = parseFloat(that.next().text());
    $(".FeeInput", container).val(Math.round(rate * ticketPrice / 100));
    var passengerFee = container.next();
    var total = 0;
    $(".faxInput", passengerFee).val(rate).each(function (itemIndex, item) {
        //var price = parseFloat($.trim($(item).parent().find(".ticketPrice").text()));
        $(item).parent().next().find("input").val(Math.round(rate * ticketPrice / 100));
        var refund = CalcRefund(rate, Math.round(rate * ticketPrice / 100), $(item).next().val());
        $(item).parent().nextAll().find(".RefundFee").val(refund);
        var tradeFee = $("#hfdTradeFee").val();
        $(item).parent().nextAll().find(".ActualRefundFee").val(Round(refund - Celling(refund * parseFloat(tradeFee), -2),2));
        total += refund;
    });
    $(".RefundTotlal", container).val(Round(total,2));
}

function FillFee(sender)
{
    var that = $(sender);
    var rate = that.parent().prev().find(".faxInput").val();
    if ($.trim(that.val()) == "") return; //|| $.trim(rate) == "") return;
    if (!feeReg.test(that.val()))
    {
        alert("手续费格式错误!");
        return;
    }
    if (!zhengshu.test(that.val()))
    {
        alert("手续费需要四舍五入到元");
        that.val(Math.round(parseFloat(that.val())));
    }
    rate = parseInt(rate);
    var fee = parseFloat(that.val());
    var container = that.parent().parent().parent();
    var passengerFee = container.next();
    var total = 0;
    $(".FeeInput", passengerFee).val(fee).each(function (itemIndex, item) {
        var refund = CalcRefund(rate, fee, $(item).parent().prev().find("input[type='hidden']").val());
        $(item).parent().parent().find(".RefundFee").val(refund);
        var tradeFee = $("#hfdTradeFee").val();
        $(item).parent().parent().find(".ActualRefundFee").val(Round(refund - Celling(refund * parseFloat(tradeFee), -2),2));
        total += refund;
    });
    $(".RefundTotlal", container).val(Round(total,2));
}

function CalcRefund(rate, refundFee, other)
{
    var result;
    var parameters;
    eval(other);
    var YinShou = parameters.Price - parameters.Commission + parameters.AirportFee + parameters.BAF ;
    if (refundFee > parameters.Price)
    {
        //alert("手续费太多了吧！");
        $(".FeeInput").val(parameters.Price);
        result = parameters.AirportFee + parameters.BAF - parameters.Commission + parameters.ServiceCharge;
        if (result < 0) return 0;
    }
//    if (rate == 100)
//    {
//        result = YinShou - refundFee - parameters.ServiceCharge;
//    } else
//    {
//        result = YinShou - refundFee - parameters.ServiceCharge;
    //    }
    result = YinShou - refundFee + parameters.ServiceCharge;
    if(result>parameters.maxRufundFee)  result = parameters.maxRufundFee;
    if (result  <= 0) return 0;
//    if (result < parameters.AirportFee + parameters.BAF)
//    {
//        result = parameters.AirportFee + parameters.BAF ;
//    }
    return Round(result, 2);
    //return Math.round(result);
}

$(function ()
{
    $("#divDeny input[type='radio']").click(function ()
    {
        $("#selDenyReason").empty();
        getDictionaryItems($(this).val(), function (rsp)
        {
            if (rsp)
            {
                for (var i in rsp)
                {
                    $("<option>" + rsp[i].Remark + "</option>").appendTo("#selDenyReason");
                }
                $("#dl_selDenyReason").remove();
                $("#selDenyReason").removeClass("custed").custSelect({ width: 326 });
            }
        });
    });

    $("#dl_selDenyReason li").live("click", function ()
    {
        $("#Reason").val($(this).find("span").text()).removeClass("null");
    });


    $(".FeeInput,.faxInput", $(".Passengers")).add(".RefundTotlal,.RefundFee,.ActualRefundFee").attr("readonly", "readonly").css({ border: "none" });

    $(".option1").click(function ()
    {
        var container = $(this).parent().parent().parent();
        container.find(".faxInput").val(100).trigger("blur");
        container.find(".FeeInput,.faxInput ").attr("disabled", "disabled");
    });
    $(".option2").click(function ()
    {
        var container = $(this).parent().parent().parent();
        container.find(".FeeInput,.faxInput ").removeAttr("disabled");
    });

    
});

function LockFeeInput()
{
    var container = $(".handle");
    $("input[type='radio']", container).attr("disabled", "disabled");
    $(".faxInput,.FeeInput", container).val(0).attr("disabled", "disabled").trigger("blur");
}