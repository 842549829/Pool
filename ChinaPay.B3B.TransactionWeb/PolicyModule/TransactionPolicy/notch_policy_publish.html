<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>缺口政策发布</title>
    <link rel="stylesheet" href="skinPath/core.css" />
    <link rel="stylesheet" href="skinPath/form.css" />
    <link rel="stylesheet" href="/Styles/icon/fontello.css" />
    <link rel="stylesheet" href="skinPath/page.css" />
    <script src="/Scripts/jquery-1.7.2.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/Scripts/widget/common.js"></script>
    <script type="text/javascript">
        LoadSkins();
    </script>
    <style>
        .text_width
        {
            width: 310px;
        }
        .notch_block_btn
        {
            background-color: #D9D9D9;
            border-radius: 3px;
            color: #333;
            display:inline-block;
            height: 30px;
            line-height: 30px;
            margin: 0 10px;
            text-align: center;
            width: 200px;
        }
        .notch_block_btn
        {
            *display:inline;
        }
        .notch_block_btn:hover
        {
            text-decoration:none;
        }
        .showTxt
        {
            margin: 5px 10px;
        }
        .notch_air
        {
            border-top:1px dashed #a3a3a3;
            border-bottom:1px dashed #a3a3a3;
            padding: 10px 0;
        }
        .notch_air label
        {
            float:left;
            line-height: 1.8;
            padding-right: 5px;
            text-align:right;
            width:65px;
        }
        .notch_air p
        {
            line-height: 1.8;
            margin-left:70px;
        }
        .notch_air .clearfix
        {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div>
        <div class="form">
            <h3 class="titleBg">
                缺口政策发布</h3>
            <table class="tab-mid">
                <colgroup>
                    <col class="w15" />
                    <col class="w35" />
                    <col class="w15" />
                    <col class="w35" />
                </colgroup>
                <tbody>
                    <tr>
                        <td class="title">
                            航空公司：
                        </td>
                        <td colspan="3">
                            <select id="selProvince" class="fl" style="line-height: 28px; margin-left: 20px;"
                                onchange="ClearBunksByTime();">
                            </select>
                            <span><span class="zidingyi fl" style="line-height: 28px; margin-left: 50px;">自定义编号</span>
                                <select id="selZidingy" class="fl zidingyi" style="line-height: 28px; margin-left: 20px;">
                                </select></span> <span id="selOfficeTd">
                                    <label class="fl" style="line-height: 28px; margin-left: 50px;">
                                        OFFICE号</label>
                                    <select id="selOffice" class="fl" style="line-height: 28px; margin-left: 20px;">
                                    </select>
                                    <span class="obvious2 fl" style="line-height: 28px;">需授权</span></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="title">
                            航段：
                        </td>
                        <td colspan="3">
                            <a href="javascript:tianxiehanduan(0);" class="notch_block_btn">填写适用航段</a> <a href="javascript:tianxiehanduan(1);" class="notch_block_btn">
                                填写排除航段</a>
                            <div class="showTxt">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="title" id="qucheng">
                            航班限制：
                        </td>
                        <td colspan="2">
                            <input type="radio" value="0" name="QuchengFilght" id="radBuXian" checked="checked" /><label
                                for="radBuXian">不限</label>
                            <input type="radio" value="1" name="QuchengFilght" id="radYiXia" /><label for="radYiXia">仅适用以下航班</label>
                            <input type="radio" value="2" name="QuchengFilght" id="radNotYiXia" /><label for="radNotYiXia">不适用以下航班</label>
                            <br />
                            <input id="txtQuChengFilght" class="text text_width" type="text" />
                        </td>
                        <td>
                            <p class="obvious1">
                                提示： 不加航空公司二字码，在输入框中输入限定的航班号，支持 * 匹配（如580*即支持5801到5809）。多航班请用“/ ”分隔，如：4590/580*
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td class="title">
                            出票条件：
                        </td>
                        <td colspan="2">
                            <textarea class="text textarea_width" id="txtDrawerCondition"></textarea>
                        </td>
                        <td class="obvious1">
                            提示：如果有特别要说明的出票条件，请填写，若没有，则不用填。本内容会展示给买家，请谨慎填写。 <a href="javascript:zidingyi(1);">自定义出票条件</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="title">
                            政策备注：
                        </td>
                        <td colspan="2">
                            <textarea class="text textarea_width" id="txtRemark"></textarea>
                        </td>
                        <td class="obvious1">
                            提示：本内容只有卖家才能查看，主要是提示出票员核对政策使用规定。避免犯错，提高操作标准。若没有，则不用填。 <a href="javascript:zidingyi(2);">
                                自定义政策备注</a>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="groupCt">
                <div class="groupBox1">
                    <div class="clearfix">
                        <div class="fl pd_right groupLine">
                            适用航班日期：
                            <input type="text" onchange='ClearBunksByTime();' class="text datepicker datefrom  class3 quchengkaishi" />
                            至
                            <input type="text" onchange='ClearBunksByTime();' class="text datepicker datefrom  class3 quchengjieshu" />
                        </div>
                        <div class="fl pd_right groupLine">
                            开始出票日期：
                            <input type="text" onchange='ClearBunksByTime();' class="text datepicker datefrom  class3 chupiao" />
                        </div>
                        <div class="fl groupLine">
                            <input type="button" class="btn class2 btnRefresh" value="刷新舱位" />
                        </div>
                    </div>
                    <div class="groupLine">
                        航班排除日期：
                        <input type="text" class="text text_width paichuriqi" />
                        <p class="obvious1 pd">
                            请填写政策航班排除日期，单天如：20121121 连续多天如:20121125-20121127 多个天数用“,”隔开。
                        </p>
                    </div>
                    <div class="pd_left shiyongbanqi">
                        适用班期：
                        <input type="checkbox" id="mon" checked='checked' value="1" />
                        <label for="mon">
                            周一</label>
                        <input type="checkbox" id="tue" checked='checked' value="2" />
                        <label for="tue">
                            周二</label>
                        <input type="checkbox" id="wed" checked='checked' value="3" />
                        <label for="wed">
                            周三</label>
                        <input type="checkbox" id="thur" checked='checked' value="4" />
                        <label for="thur">
                            周四</label>
                        <input type="checkbox" id="fri" checked='checked' value="5" />
                        <label for="fri">
                            周五</label>
                        <input type="checkbox" id="sat" checked='checked' value="6" />
                        <label for="sat">
                            周六</label>
                        <input type="checkbox" id="sun" checked='checked' value="7" />
                        <label for="sun">
                            周日</label><span class="obvious1">提示：若某个班期不适用，请将周期前的勾去掉</span>
                    </div>
                </div>
                <div class="groupBox2">
                    <table>
                        <tr>
                            <th>
                                舱位
                            </th>
                            <th>
                                客票类型
                            </th>
                            <th class='canHaveSubordinate' style='display: none;'>
                                内部佣金
                            </th>
                            <th>
                                下级佣金
                            </th>
                            <th class='allowBrotherPurchase' style='display: none;'>
                                同行佣金
                            </th>
                        </tr>
                        <tr>
                            <td class="BunksRad bspcangwei">
                                <label class='refBtnBunks btn class3 btnRefresh'>
                                    点击获取舱位</label>
                            </td>
                            <td class='BSP'>
                                <input type="checkbox" checked="checked" id="bsp" />
                                <label for="bsp">
                                    BSP</label>
                            </td>
                            <td class='canHaveSubordinate' style='display: none;'>
                                <input type="text" class="text text-s bspneibufanyong" />%
                            </td>
                            <td>
                                <input type="text" class="text text-s bspxiajifanyong" />%
                            </td>
                            <td class="allowBrotherPurchase" style='display: none;'>
                                <input type="text" class="text text-s bsptonghangfanyong" />%
                            </td>
                        </tr>
                        <tr>
                            <td class="BunksRad b2bcangwei">
                                <label class='refBtnBunks btn class3 btnRefresh'>
                                    点击获取舱位</label>
                            </td>
                            <td class='B2B'>
                                <input type="checkbox" checked="checked" id="b2b" class='chkb2b' />
                                <label for="b2b">
                                    B2B</label>
                                <br />
                                <span style='margin-left: 125px' class='qfqcp'>
                                    <input type='checkbox' id='qfqcp' class='qfqcp' style='margin-left: 20px;' />
                                    <label for='qfqcp' class='qfqcp'>
                                        起飞前2小时内可出票</label></span>
                            </td>
                            <td class='canHaveSubordinate' style='display: none;'>
                                <input type="text" class="text text-s b2bneibufanyong" />%
                            </td>
                            <td>
                                <input type="text" class="text text-s b2bxiajifanyong" />%
                            </td>
                            <td class="allowBrotherPurchase" style='display: none;'>
                                <input type="text" class="text text-s b2btonghangfanyong" />%
                            </td>
                        </tr>
                    </table>
                    <div class="clearfix">
                        <div class="fl policy_check">
                            <input type="checkbox" id="zjsh" />
                            <label for="zjsh">
                                直接审核</label>
                            <input type="checkbox" id="hbmcp" />
                            <label for="hbmcp">
                                需换编码出票</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <label style="display: none;" id="inputTxtvalue">
        </label>
        <div class="btns">
            <input type="button" class="btn class1" id="btnPublish" value="发      布" />
            <input type="button" class="btn class1" id="btnPolicyAdd" value="发布并继续" />
            <input type="button" class="btn class2" id="btnReturn" value="返      回" />
        </div>
        <a id="divOpcial" style="display: none;" data="{type:'pop',id:'divZidingyi'}"></a>
        <div id="divZidingyi" class="form layer3" style="display: none; width: 700px;">
            <div class='hd'>
                <h4>
                    自定义条件<a class='close' href="javascript:void(0)">关闭</a></h4>
            </div>
            <div class="table customerTb" id="divZidingyiTb">
            </div>
        </div>
        <a id="divHangduan" style="display: none;" data="{type:'pop',id:'hangduanxinxi'}">
        </a>
        <div id="hangduanxinxi" class="layer3" style="display: none; width: 800px;">
            <h4>
                <span class="tip">设置缺口程政策所包含的航段信息</span> <a class='close' href="javascript:void(0)">
                    关闭</a></h4>
            <div class="layer3Tips">
                只有编码中包含/排除您设置的航段，您的政策才会展示给采购并进行选择操作。</div>
            <div class="clearfix">
                <table>
                    <tr>
                        <td>
                            <div class="fl" style="width: 399px; border-right: 1px dashed #c1c1c1;">
                                <div style="width: 320px; margin: 10px auto;">
                                    <h4 style="text-align: center;">
                                        始发地</h4>
                                    <div class="s-dbl_select">
                                        <br />
                                        <input type="text" class="text text_width" id="txtAirports" /><br />
                                        <div class="op_item">
                                            <select class="op_con op_con_l" id="lbSource" multiple="multiple">
                                            </select>
                                            <select class="op_con op_con_r" id="lbSelected" multiple="multiple">
                                            </select>
                                            <div class="btns">
                                                <button class="btn class2" id="btnAddAll" runat="server">
                                                    全部添加</button>
                                                <button class="btn class2" id="btnAdd" runat="server">
                                                    添&nbsp;&nbsp; &nbsp;&nbsp; 加</button>
                                                <button class="btn class2" id="btnRemove" runat="server">
                                                    删&nbsp;&nbsp; &nbsp;&nbsp; 除</button>
                                                <button class="btn class2" id="btnRemoveAll" runat="server">
                                                    全部删除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="fl" >
                                <div style="width: 320px; margin: 10px auto;">
                                    <h4 style="text-align: center;">
                                        目的地</h4>
                                    <div class="s-dbl_select">
                                        <br />
                                        <input type="text" class="text text_width" id="txtAirports1" /><br />
                                        <div class="op_item">
                                            <select class="op_con op_con_l" id="lbSource1" multiple="multiple">
                                            </select>
                                            <select class="op_con op_con_r" id="lbSelected1" multiple="multiple">
                                            </select>
                                            <div class="btns">
                                                <button class="btn class2" id="btnAddAll1" runat="server">
                                                    全部添加</button>
                                                <button class="btn class2" id="btnAdd1" runat="server">
                                                    添&nbsp;&nbsp; &nbsp;&nbsp; 加</button>
                                                <button class="btn class2" id="btnRemove1" runat="server">
                                                    删&nbsp;&nbsp; &nbsp;&nbsp; 除</button>
                                                <button class="btn class2" id="btnRemoveAll1" runat="server">
                                                    全部删除</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div class="btns">
                <input type="button" value="确认" class="btn class1 btnQueren" />
                <input type="button" value="取消" class="btn class2 btnQuexiao" />
            </div>
        </div>
    </div>
    <script src="/Scripts/DateExtandJSCount-min.js" type="text/javascript"></script>
    <script src="/Scripts/json2.js" type="text/javascript"></script>
    <script src="/Scripts/airport.js" type="text/javascript"></script>
    <script src="/Scripts/PolicyModule/Policy_Airports.js" type="text/javascript"></script>
    <script src="/Scripts/DatePicker/WdatePicker.js" type="text/javascript"></script>
    <script src="/Scripts/widget/common.js" type="text/javascript"></script>
    <script src="/Scripts/PolicyModule/policy_publish.js?20130516" type="text/javascript"></script>
    <script src="/Scripts/PolicyModule/policy_draw.js?2013051601" type="text/javascript"></script>
    <script src="/Scripts/PolicyModule/notch_policy_publish.js?20130516" type="text/javascript"></script>
    <script type="text/javascript">
        function tianxiehanduan(p) {
            $(".inputTxt").show();
            if (p == 0) {
                $(".tip").html("设置缺口程政策所包含的航段信息");
            } else {
                $(".tip").html("设置缺口程政策所排除的航段信息");
            }
            $("#divHangduan").click(); $("#hangduanxinxi").css("top", "100px");
        }

        $(function () {
            $("#btnReturn").click(function () {
                window.location.href = "./notch_policy_manage.aspx";
            });
            $("#btnPublish").click(function () {
                GetPolicy("add");
            });
            $("#btnPolicyAdd").click(function () {
                GetPolicy("jixu");
            });
            AirportsArrivals();
            AirportsDepartures();
            $(".btnQuexiao").click(function () {
                $(".inputTxt").hide();
                $(".close").click();
            });
            $(".btnQueren").click(function () {
                var kaishi = $("#txtAirports").val().toUpperCase();
                var jiesu = $("#txtAirports1").val().toUpperCase();
                if (kaishi == "") {
                    alert("出发地不能为空！");
                    return;
                }
                if (jiesu == "") {
                    alert("到达地不能为空！");
                    return;
                }

                var val = $.trim($("#inputTxtvalue").html());
                var tipText = "";
                var valTxt = "";
                if ($(".tip").html() == "设置缺口程政策所包含的航段信息") {
                    tipText = "适用航段 ";
                    valTxt = 1;
                } else {
                    tipText = "排除航段 ";
                    valTxt = 0;
                }
                var curr = valTxt + "|" + kaishi + "|" + jiesu;
                var le = val.split(',');
                var f = false;
                for (var l = 0; l < le.length; l++) {
                    if ($.trim(le[l]) == curr) {
                        f = true;
                        break;
                    }
                }

                if (f) {
                    alert("当前 " + tipText + " 存在相同的航段，请勿重复添加！");
                    return;
                }

                if (val == "") {
                    $("#inputTxtvalue").html(curr);
                } else {
                    $("#inputTxtvalue").html(val + "," + curr);
                }
                $(".showTxt").html($(".showTxt").html() + "<div class='notch_air'><div class='clearfix'><label>" + tipText + "</label><p class='text-auto'>" + kaishi + "</p></div><div class='clearfix'><label>至：</label><p class='text-auto'>" + jiesu + "</p></div><p><input type='button' value='删除' class='btn class2 btnShanchu' airports='" + valTxt + "|" + kaishi + "|" + jiesu + "' /></p></div>");
                $("#btnRemoveAll").click();
                $("#btnRemoveAll1").click();
                $(".inputTxt").hide();
                $(".close").click();
            });
            $(".btnShanchu").live("click", function () {
                $(this).parent().parent().remove();
                var val = $.trim($("#inputTxtvalue").html());
                var values = val.split(',');
                var arry = "";
                for (var i = 0; i < values.length; i++) {
                    if (values[i] != $(this).attr("airports")) {
                        if (arry != "") {
                            arry += ",";
                        }
                        arry += values[i];
                    }
                }
                $("#inputTxtvalue").html(arry);
            });
            $(".wfjc").css("display", "none");

            $(".chkb2b").live("click", function () {
                if (!$(this).is(":checked")) {
                    $(this).parent().find(".qfqcp").css("visibility", "hidden");
                } else {
                    $(this).parent().find(".qfqcp").css("visibility", "");
                }
            });

            $(".btnRefresh").live("click", function () {
                var policyDepartureFilghtDataStart = $(".quchengkaishi").val();
                var policyDepartureFilghtDataEnd = $(".quchengjieshu").val();
                var policyStartPrintDate = $(".chupiao").val();
                if (policyDepartureFilghtDataStart == "" || policyDepartureFilghtDataEnd == "" || policyStartPrintDate == "") {
                    alert("去程航班日期，开始出票日期不能为空!");
                    return;
                }
                if (valiateDateTime(policyDepartureFilghtDataStart, policyDepartureFilghtDataEnd)) {
                    alert("去程日期范围有误！结束时间不能小于开始时间");
                    return;
                }
                if (valiateDateTime(policyStartPrintDate, policyDepartureFilghtDataStart)) {
                    alert("出票时间不能大于去程的开始时间!");
                    return;
                }
                //查询舱位
                var param = { "airline": $("#selProvince").val(), "startTime": policyDepartureFilghtDataStart, "endTime": policyDepartureFilghtDataEnd, "startETDZDate": policyStartPrintDate };
                sendPostRequest("/PolicyHandlers/PolicyManager.ashx/QueryNotchBunksPolicy", JSON.stringify(param), function (e) {
                    var str = "<input type='radio' value='0' name='1radio' id='1all'  class='choice' /><label for='1all'> 全选</label> <input type='radio' value='1' name='1radio' id='1not' class='choice' /><label for='1not'> 反选</label><br />";
                    var str1 = "<input type='radio' value='0' name='1radio1' id='1all1'  class='choice' /><label for='1all1'> 全选</label> <input type='radio' value='1' name='1radio1' id='1not1' class='choice' /><label for='1not1'> 反选</label><br />";
                    $.each(eval(e), function (i, item) {
                        str1 += "<input type='checkbox' value='" + item + "'/>" + item;
                        str += "<input type='checkbox' value='" + item + "'/>" + item;
                        if ((i + 1) % 4 == 0 && i > 0) {
                            str += "<br />";
                            str1 += "<br />";
                        }
                    });
                    $(".BunksRad").eq(0).html(str);
                    $(".BunksRad").eq(1).html(str1);
                }, function (e) {
                    if (e.status == 300) {
                        alert(JSON.parse(e.responseText));
                    } else {
                        alert(e.statusText);
                    }
                });

            });



            //查询Office号
            var url;
            url = "/PolicyHandlers/RoleGeneralPolicy.ashx/GetOfficeNumbers";
            var actionName;
            actionName = "Office";
            ResquetQueryAction(url, actionName, null);

            //查询公司参数
            url = "/PolicyHandlers/PolicyManager.ashx/GetCompanySetting";
            actionName = "GetCompanySetting";
            ResquetQueryAction(url, actionName, null);
        });
        //验证日期
        function valiateDateTime(lowerDate, upperDate) {
            if ((lowerDate == "" || lowerDate == null) || (upperDate == "" || upperDate == null)) {
                return false;
            }
            else {
                var startDate = parseInt(lowerDate.replace(/-/g, ''), 10);
                var endDate = parseInt(upperDate.replace(/-/g, ''), 10);
                if (startDate > endDate) {
                    return true;
                } else {
                    return false;
                }
            }
        }
        function ClearBunksByTime() {
            $(".BunksRad").html("<label class='btnRefresh btn class3'>点击获取舱位</label>");
        };
    </script>
</body>
</html>
